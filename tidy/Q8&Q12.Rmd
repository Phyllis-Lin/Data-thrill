---
title: "Q8 and Q12"
author: "Yiwen Liu"
date: "10/14/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, messages=FALSE, warning=FALSE)
# Make sure you have the latest versions of rmarkdown and bookdown installed
library(ggplot2)
library(tidyverse)
hotels <- read.csv("data/hotels.csv")
```

```{r check NA}
Miss_tidy <- sapply(hotels, function(x) sum(is.na(x))) #check wether have mssing value in data set
Miss_tidy

```

```{r clean missing}
hotel <- na.omit(hotels)
```

## Q8:Which country’s people most like to repeat to reserve these hotels?

People can find which country’s people most like to repeat to reserve the same hotel, City Hotel or Resort Hotel when they come to Portugal from the bar plots. The proportion is well shown on the graphs.

```{r Q8_1}
library(tidytext)
hotel%>%
  select(hotel,country,is_repeated_guest)%>%
  group_by(hotel,country)%>%
  count(is_repeated_guest)%>%
  pivot_wider(names_from="is_repeated_guest",values_from=n)%>%
  rename(not_repeated_guest="0",repeated_guest="1")%>%
  filter(!is.na(repeated_guest))%>%
  mutate(prop=repeated_guest/(not_repeated_guest+repeated_guest))%>%
  arrange(desc(prop))%>% 
  ungroup()%>%
  slice_head(n =20)%>%
  ggplot(aes(x=reorder(country,prop),y=prop,fill=hotel))+
  geom_col()+
  coord_flip()+
  facet_wrap(~hotel,scales = "free")+
  theme_minimal()+
  labs(title = "Repeated guest proportion of different countries from July 2015 to August 2017",
       x = "",
       y="proportion")
```
arrange( variable  )  %>%  slice_head(n =20)

```{r Q8_2}
library(gridExtra)
a <- hotel%>%
  select(hotel,country,is_repeated_guest)%>%
  count(hotel,country,is_repeated_guest)%>%
  pivot_wider(names_from="is_repeated_guest",values_from=n)%>%
  rename(not_repeated_guest="0",repeated_guest="1")%>%
  filter(!is.na(repeated_guest))%>%
  mutate(prop=round(repeated_guest/(not_repeated_guest+repeated_guest),digits=4))%>%
  arrange(desc(prop))%>% 
  ungroup()%>%
  slice_head(n =20)

prop_c <- a%>%
  filter(hotel=="City Hotel")%>%
  ggplot(aes(x=reorder(country,prop),y=prop))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  theme_minimal()+
  labs(title = "Repeated guest proportion of City Hotel from July 2015 to August 2017",
       x = "",
       y="proportion")+
  theme(plot.title=element_text(size=7))+
  geom_text(aes(label=prop),hjust = -0.008, size = 2)+
  scale_y_continuous(limits=c(0,1),breaks=seq(0,1,0.1))


prop_r <- a%>%
  filter(hotel=="Resort Hotel")%>%
  ggplot(aes(x=reorder(country,prop),y=prop))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  theme_minimal()+
  labs(title = "Repeated guest proportion of Resort Hotel from July 2015 to August 2017",
       x = "",
       y="proportion")+
  theme(plot.title=element_text(size=7))+
  geom_text(aes(label=prop),hjust = -0.008, size = 2)+
  scale_y_continuous(limits=c(0,1),breaks=seq(0,1,0.1))

grid.arrange(prop_c,prop_r,ncol=2)


```


## Q12:How close to the arrival data is the booking being cancelled?

From the bar plot and density plot, people would clearly know that how close to the arrival data that guests have the most probability to cancel current booking.

```{r Q12_1}
library(lubridate)
plot_interval<- hotel%>%
  filter(is_canceled==1)%>%
  select(hotel,is_canceled,arrival_date_year,arrival_date_month,arrival_date_day_of_month,reservation_status,reservation_status_date)%>%
  mutate(arrival_date_month = case_when(
    arrival_date_month=="January" ~ "01",
    arrival_date_month=="February" ~ "02",
    arrival_date_month=="March" ~ "03",
    arrival_date_month=="April" ~ "04",
    arrival_date_month=="May" ~ "05",
    arrival_date_month=="June" ~ "06",
    arrival_date_month=="July" ~ "07",
    arrival_date_month=="August" ~ "08",
    arrival_date_month=="September" ~ "09",
    arrival_date_month=="October" ~ "10",
    arrival_date_month=="November" ~ "11",
    arrival_date_month=="December" ~ "12"
  ))%>%
  mutate(arrival_time=paste(arrival_date_year,arrival_date_month,arrival_date_day_of_month,sep="-"))%>%
  select(hotel,is_canceled,reservation_status,reservation_status_date,arrival_time)%>%
  filter(reservation_status=="Canceled")%>%
  mutate(reservation_status_date=ymd(reservation_status_date),
         arrival_time=ymd(arrival_time))%>%
  mutate(interval=arrival_time-reservation_status_date)

plot_interval%>%
  ggplot(aes(x=interval))+
  geom_bar()+
  facet_wrap(~hotel)
  theme_bw()
```

```{r Q12_2}
interval_c <- plot_interval%>%
  filter(hotel=="City Hotel")%>%
  ggplot(aes(x = interval,
             y = ..density..)) +
  geom_density(fill = "white") +
  geom_vline(xintercept = mean(plot_interval$interval),
             colour = "red")
interval_c

interval_r <- plot_interval%>%
  filter(hotel=="Resort Hotel")%>%
  ggplot(aes(x = interval,
             y = ..density..)) +
  geom_density(fill = "white") +
  geom_vline(xintercept = mean(plot_interval$interval),
             colour = "red")
interval_r

grid.arrange(interval_c,interval_r,ncol=2)
```

