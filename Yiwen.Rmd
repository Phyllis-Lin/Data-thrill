---
title: "Expert advice from experts"
author:
- familyname: Curie
  othernames: Marie
  address: University of Paris
  email: mcurie.notreal@gmail.com
  correspondingauthor: true
  qualifications: Nobel Prize, PhD
- familyname: Curie
  othernames: Pierre
  address: University of Paris
  qualifications: Nobel Prize, PhD
department: Department of\newline Econometrics &\newline Business Statistics
organization: Acme Corporation
bibliography: references.bib
biblio-style: authoryear-comp
linestretch: 1.5
output:
  MonashEBSTemplates::report:
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    includes:
      in_header: preamble.tex
    keep_tex: yes
    number_sections: yes
    citation_package: biblatex
    toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, messages=FALSE, warning=FALSE)
# Make sure you have the latest versions of rmarkdown and bookdown installed
library(ggplot2)
library(tidyverse)
library(countrycode)
library(lubridate)
library(naniar)
hotels <- read.csv("data/hotels.csv")
```

```{r check NA}
Miss_tidy <- vis_miss(hotels, warn_large_data =FALSE) #check wether have mssing value in data set
Miss_tidy
```


```{r clean missing}
hotel <- na.omit(hotels)
```

```{r change_format}
hotel <- hotel %>% mutate(
    arr_date_month = case_when(   # change Month to the numeric 
    arrival_date_month=="January" ~ 01,
    arrival_date_month=="February" ~ 02,
    arrival_date_month=="March" ~ 03,
    arrival_date_month=="April" ~ 04,
    arrival_date_month=="May" ~ 05,
    arrival_date_month=="June" ~ 06,
    arrival_date_month=="July" ~ 07,
    arrival_date_month=="August" ~ 08,
    arrival_date_month=="September" ~ 09,
    arrival_date_month=="October" ~ 10,
    arrival_date_month=="November" ~ 11,
    arrival_date_month=="December" ~ 12),
    country = str_replace(country, pattern = "cn", replacement = "chn"), # replace China pattern
    deposit = case_when(deposit_type == "No Deposit"~0,            # Change deposit as binary numeric
                        deposit_type == "Non Refund"~1,
                         deposit_type == "Refundable"~2),
   arrival_time=paste(arrival_date_year,
                      arrival_date_month,
                      arrival_date_day_of_month,
                      sep="-"))%>%
   mutate(Country = countrycode(sourcevar = country,              # According the country code to find the country full name
                                      origin = "iso3c",
                                      destination = "country.name"),
          reservation_status_date=ymd(reservation_status_date),
         arrival_time=ymd(arrival_time)) 
```


```{r tidy}
tidy <- hotel %>% dplyr::select(-market_segment,
                               -distribution_channel,
                               -deposit_type,
                               -agent,
                               -company) 
```


```{r}
final <- na.omit(tidy)  # Delete the missing country observations
  
```



## Q8:Which country’s people most like to repeat to reserve these hotels?
（it is a question about the customer/booking）

People can find which country’s people most like to repeat to reserve the same hotel, the City Hotel or the Resort Hotel when they come to Portugal from the bar plots. They show the top 10 rank about the proportion of repeated guests for the Resort Hotel and the City Hotel from 2015 to 2017. It is obvious that the proportion of the Resort Hotel was much higher than that of the City Hotel.

The main reason for that may have something to do with the location of this two hotels.The City Hotel is located in the center of the country and there are more hotels in that place, so there are more options for customers to pick one hotel they like, while the Resort Hotel is located in the suburb, and there are not many options for customers to choose different hotels.So the proportion of repeated customers are higher in the Resort Hotel.


```{r Q8_1}
library(gridExtra)
a <- final%>%
  select(hotel,Country,is_repeated_guest)%>%
  count(hotel,Country,is_repeated_guest)%>%
  pivot_wider(names_from="is_repeated_guest",values_from=n)%>%
  rename(not_repeated_guest="0",repeated_guest="1")%>%
  filter(!is.na(repeated_guest))%>%
  mutate(prop=round(repeated_guest/(not_repeated_guest+repeated_guest),digits=3))%>%
  arrange(desc(prop))%>% 
  ungroup()%>%
  slice_head(n =20)

prop_c <- a%>%
  filter(hotel=="City Hotel")%>%
  ggplot(aes(x=reorder(Country,prop),y=prop))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  theme_minimal()+
  labs(title = "Repeated guest proportion of City Hotel from July 2015 to August 2017",
       x = "",
       y="proportion")+
  theme(plot.title=element_text(size=11.5))+
  geom_text(aes(label=prop),hjust = -0.008, size = 2)+
  scale_y_continuous(breaks=seq(0,1,0.02))



prop_r <- a%>%
  filter(hotel=="Resort Hotel")%>%
  ggplot(aes(x=reorder(Country,prop),y=prop))+
  geom_col(show.legend = FALSE)+
  coord_flip()+
  theme_minimal()+
  labs(title = "Repeated guest proportion of Resort Hotel from July 2015 to August 2017",
       x = "",
       y="proportion")+
  theme(plot.title=element_text(size=11.5))+
  geom_text(aes(label=prop),hjust = -0.008, size = 2)+
  scale_y_continuous(breaks=seq(0,1,0.2))

grid.arrange(prop_c,prop_r,ncol=2)
```


## Q12:How close to the arrival date is the booking being cancelled?
（it is a question about the hotel/cancelled）

From the bar plots and density plot, people would clearly know that how close to the arrival data that customers have the most probability to cancel their current booking.

From the bar plots,it clearly shows that both of the two hotels have the similar distribution about the interval which represents the day between the original arrival day and the reservation cancelled day. People could find that to the City Hotel, most of the interval is between 0 to 270 days while to the Resort Hotel, that is between 0 to 150 days.

The density plot shows a similar right skewed shape.The red line represents the average interval days of the City Hotel and the blue line represents the average interval days of the Resort Hotel.So it may help people to seize the opportunity to book this two hotels again 80 to 90 days before they want to stay if they do not reserve rooms before.

```{r Q12_1}
library(lubridate)
plot_interval<- final%>%
  filter(is_canceled==1)%>%
  select(hotel,is_canceled,reservation_status,reservation_status_date,arrival_time)%>%
  filter(reservation_status=="Canceled")%>%
  mutate(reservation_status_date=ymd(reservation_status_date),
         arrival_time=ymd(arrival_time))%>%
  mutate(interval=arrival_time-reservation_status_date)

plot_interval%>%
  ggplot(aes(x=interval))+
  geom_bar()+
  scale_x_continuous(breaks=seq(0,600,50))+
  theme(axis.text.x=element_text(angle=90))+
  labs(x="interval(day)")+
  facet_wrap(~hotel)
```

```{r Q12_2}
interval_c <- plot_interval%>%
  filter(hotel=="City Hotel")

interval_r <- plot_interval%>%
  filter(hotel=="Resort Hotel")

plot_combined <- plot_interval%>%
  ggplot(aes(interval,fill=as.factor(hotel)))+
  geom_density(alpha=0.3)+
  geom_vline(xintercept = mean(interval_c$interval),
             colour = "red")+
  geom_vline(xintercept = mean(interval_r$interval),
             colour = "blue")+
  labs(x="interval(day)")

plot_combined
```
